<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="Admin Dashboard for RSIGCI - Manage job postings and applications" />
    <title>Admin Dashboard | RSIGCI</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-storage-compat.js"></script>
    <script src="firebase-config.js"></script>
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
      
      * {
        font-family: 'Inter', sans-serif;
      }
      
      .gradient-bg {
        background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 50%, #1e40af 100%);
      }
      
      .glass-effect {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }
      
      .hover-lift {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }
      
      .hover-lift:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
      }
      
      .fade-in {
        opacity: 0;
        transform: translateY(20px);
        animation: fadeInUp 0.8s ease-out forwards;
      }
      
      @keyframes fadeInUp {
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      
      .slide-in-left {
        opacity: 0;
        transform: translateX(-30px);
        animation: slideInLeft 0.8s ease-out forwards;
      }
      
      @keyframes slideInLeft {
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }
      
      .stagger-1 { animation-delay: 0.1s; }
      .stagger-2 { animation-delay: 0.2s; }
      .stagger-3 { animation-delay: 0.3s; }
      
      .btn-primary {
        background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
      }
      
      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(249, 115, 22, 0.3);
      }
      
      .form-input {
        transition: all 0.3s ease;
        border: 2px solid transparent;
      }
      
      .form-input:focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        outline: none;
      }
      
      .tab-active {
        background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);
        color: white;
      }
      
      .application-card {
        overflow-y: auto;
        overflow-x: hidden;
        word-break: break-word;
      }
      
      .application-card:hover {
        border-color: #3b82f6;
        transform: translateY(-2px);
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
      }
      
      .status-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 500;
      }
      
      .status-new { background-color: #dbeafe; color: #1e40af; }
      .status-reviewing { background-color: #fef3c7; color: #d97706; }
      .status-approved { background-color: #d1fae5; color: #059669; }
      .status-rejected { background-color: #fee2e2; color: #dc2626; }
      
      .sidebar {
        transition: transform 0.3s ease;
      }
      
      @media (max-width: 768px) {
        .sidebar {
          transform: translateX(-100%);
        }
        .sidebar.open {
          transform: translateX(0);
        }
      }
      
      .icon-btn {
        width: 2.5rem;
        height: 2.5rem;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 9999px;
        transition: background 0.2s, box-shadow 0.2s;
        box-shadow: 0 0 0 0 transparent;
        border: none;
        outline: none;
        padding: 0;
        margin: 0 0.25rem;
      }
      .icon-btn:focus, .icon-btn:hover {
        box-shadow: 0 2px 8px 0 rgba(0,0,0,0.10);
      }
      .icon-btn i {
        font-size: 1.25rem;
        margin: 0;
      }
      .view-btn {
        height: 2.5rem;
        width: 4.5rem;
        min-width: 4.5rem;
        max-width: 4.5rem;
        padding: 0 0.5rem;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 0.75rem;
        font-size: 1rem;
        font-weight: 600;
        margin: 0 0.25rem;
        transition: background 0.2s, box-shadow 0.2s;
        white-space: nowrap;
      }
      .view-btn:focus, .view-btn:hover {
        box-shadow: 0 2px 8px 0 rgba(0,0,0,0.10);
      }
      .cover-letter-truncated {
        white-space: pre-line;
        word-break: break-word;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 100%;
        vertical-align: middle;
      }
      .expand-btn {
        background: none;
        border: none;
        outline: none;
        cursor: pointer;
        padding: 0 0.5rem;
        color: #3b82f6;
        font-size: 1.25rem;
        vertical-align: middle;
        transition: color 0.2s;
      }
      .expand-btn:hover {
        color: #1e40af;
      }
      .application-card.expanded .cover-letter-truncated {
        -webkit-line-clamp: unset;
        -webkit-box-orient: unset;
        overflow: visible;
        text-overflow: initial;
        display: block;
      }
      .modal-cover-letter {
        white-space: pre-line;
        word-break: break-word;
        overflow-x: hidden;
      }
    </style>
  </head>
  <body class="bg-gray-50 text-gray-800">
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
      <div class="bg-white p-8 rounded-lg shadow-xl text-center max-w-sm mx-4">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
        <p class="text-lg font-semibold text-gray-800">Processing...</p>
        <p class="text-sm text-gray-600 mt-2">Please wait while we process your request</p>
      </div>
    </div>

    <!-- Sidebar -->
    <div id="sidebar" class="sidebar fixed top-0 left-0 h-full w-64 bg-white shadow-lg z-40 md:translate-x-0">
      <div class="p-6">
        <div class="flex items-center mb-8">
          <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center mr-3">
            <i class="fas fa-building text-white text-xl"></i>
          </div>
          <div>
            <h1 class="text-xl font-bold text-gray-800">RSIGCI</h1>
            <p class="text-sm text-gray-500">Admin Dashboard</p>
          </div>
        </div>
        
        <nav class="space-y-2">
          <button onclick="showTab('dashboard')" class="tab-btn w-full text-left px-4 py-3 rounded-lg hover:bg-gray-100 transition-colors flex items-center">
            <i class="fas fa-tachometer-alt mr-3"></i>
            Dashboard
          </button>
          <button onclick="showTab('jobs')" class="tab-btn w-full text-left px-4 py-3 rounded-lg hover:bg-gray-100 transition-colors flex items-center">
            <i class="fas fa-briefcase mr-3"></i>
            Job Postings
          </button>
          <button onclick="showTab('applications')" class="tab-btn w-full text-left px-4 py-3 rounded-lg hover:bg-gray-100 transition-colors flex items-center">
            <i class="fas fa-users mr-3"></i>
            Applications
          </button>
          <button onclick="showTab('new-job')" class="tab-btn w-full text-left px-4 py-3 rounded-lg hover:bg-gray-100 transition-colors flex items-center">
            <i class="fas fa-plus mr-3"></i>
            Post New Job
          </button>
        </nav>
      </div>
    </div>

    <!-- Mobile Menu Button -->
    <div class="md:hidden fixed top-4 left-4 z-50">
      <button onclick="toggleSidebar()" class="bg-white p-2 rounded-lg shadow-lg">
        <i class="fas fa-bars text-gray-600"></i>
      </button>
    </div>

    <!-- Main Content -->
    <div class="md:ml-64 min-h-screen">
      <!-- Header -->
      <header class="gradient-bg text-white p-6">
        <div class="flex justify-between items-center">
          <div>
            <h1 class="text-2xl font-bold">Admin Dashboard</h1>
            <p class="text-blue-100">Manage job postings and applications</p>
          </div>
          <div class="flex items-center space-x-4">
            <div class="text-right">
              <p class="text-sm text-blue-100">Welcome back</p>
              <p class="font-semibold">HR Manager</p>
            </div>
            <div class="w-10 h-10 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
              <i class="fas fa-user text-white"></i>
            </div>
            <a href="index.html" target="_blank" class="ml-4 bg-white bg-opacity-20 hover:bg-opacity-40 text-white px-4 py-2 rounded-lg font-semibold transition-colors">Go to Homepage</a>
          </div>
        </div>
      </header>

      <!-- Content Area -->
      <main class="p-6">
        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content fade-in">
          <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white p-6 rounded-xl shadow-sm hover-lift">
              <div class="flex items-center">
                <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center mr-4">
                  <i class="fas fa-briefcase text-blue-600 text-xl"></i>
                </div>
                <div>
                  <p class="text-sm text-gray-500">Active Jobs</p>
                  <p class="text-2xl font-bold text-gray-800" id="activeJobsCount">0</p>
                </div>
              </div>
            </div>
            
            <div class="bg-white p-6 rounded-xl shadow-sm hover-lift">
              <div class="flex items-center">
                <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center mr-4">
                  <i class="fas fa-users text-green-600 text-xl"></i>
                </div>
                <div>
                  <p class="text-sm text-gray-500">Total Applications</p>
                  <p class="text-2xl font-bold text-gray-800" id="totalApplicationsCount">0</p>
                </div>
              </div>
            </div>
            
            <div class="bg-white p-6 rounded-xl shadow-sm hover-lift">
              <div class="flex items-center">
                <div class="w-12 h-12 bg-orange-100 rounded-lg flex items-center justify-center mr-4">
                  <i class="fas fa-clock text-orange-600 text-xl"></i>
                </div>
                <div>
                  <p class="text-sm text-gray-500">New Applications</p>
                  <p class="text-2xl font-bold text-gray-800" id="newApplicationsCount">0</p>
                </div>
              </div>
            </div>
            
            <div class="bg-white p-6 rounded-xl shadow-sm hover-lift">
              <div class="flex items-center">
                <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center mr-4">
                  <i class="fas fa-check-circle text-purple-600 text-xl"></i>
                </div>
                <div>
                  <p class="text-sm text-gray-500">Approved</p>
                  <p class="text-2xl font-bold text-gray-800" id="approvedCount">0</p>
                </div>
              </div>
            </div>
          </div>

          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="bg-white p-6 rounded-xl shadow-sm">
              <h3 class="text-lg font-semibold mb-4">Recent Applications</h3>
              <div id="recentApplications" class="space-y-3">
                <!-- Recent applications will be populated here -->
              </div>
            </div>
            
            <div class="bg-white p-6 rounded-xl shadow-sm">
              <h3 class="text-lg font-semibold mb-4">Active Job Postings</h3>
              <div id="activeJobs" class="space-y-3">
                <!-- Active jobs will be populated here -->
              </div>
            </div>
          </div>
        </div>

        <!-- Jobs Tab -->
        <div id="jobs" class="tab-content hidden">
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold">Job Postings</h2>
            <button onclick="showTab('new-job')" class="btn-primary px-6 py-3 rounded-lg text-white font-medium">
              <i class="fas fa-plus mr-2"></i>Post New Job
            </button>
          </div>
          
          <div class="bg-white rounded-xl shadow-sm overflow-hidden">
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead class="bg-gray-50">
                  <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Position</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Location</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Applications</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                  </tr>
                </thead>
                <tbody id="jobsTableBody" class="bg-white divide-y divide-gray-200">
                  <!-- Jobs will be populated here -->
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Applications Tab -->
        <div id="applications" class="tab-content hidden">
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold">Applications</h2>
            <div class="flex space-x-2">
              <select id="statusFilter" class="form-input px-4 py-2 border border-gray-300 rounded-lg">
                <option value="">All Status</option>
                <option value="new">New</option>
                <option value="reviewing">Reviewing</option>
                <option value="approved">Approved</option>
                <option value="rejected">Rejected</option>
              </select>
              <select id="positionFilter" class="form-input px-4 py-2 border border-gray-300 rounded-lg">
                <option value="">All Positions</option>
                <!-- Positions will be populated dynamically -->
              </select>
            </div>
          </div>
          
          <div id="applicationsList" class="grid gap-6">
            <!-- Applications will be populated here -->
          </div>
        </div>

        <!-- New Job Tab -->
        <div id="new-job" class="tab-content hidden">
          <div class="max-w-4xl mx-auto">
            <h2 class="text-2xl font-bold mb-6">Post New Job Position</h2>
            
            <form id="newJobForm" class="bg-white p-8 rounded-xl shadow-sm">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Job Title *</label>
                  <input type="text" id="jobTitle" class="form-input w-full px-4 py-3 border border-gray-300 rounded-lg" required />
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Location *</label>
                  <input type="text" id="jobLocation" class="form-input w-full px-4 py-3 border border-gray-300 rounded-lg" required />
                </div>
              </div>
              
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Employment Type *</label>
                  <select id="jobType" class="form-input w-full px-4 py-3 border border-gray-300 rounded-lg" required>
                    <option value="">Select type</option>
                    <option value="Full-time">Full-time</option>
                    <option value="Part-time">Part-time</option>
                    <option value="Contract">Contract</option>
                    <option value="Commission-based">Commission-based</option>
                  </select>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Department</label>
                  <input type="text" id="jobDepartment" class="form-input w-full px-4 py-3 border border-gray-300 rounded-lg" />
                </div>
              </div>
              
              <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">Job Description *</label>
                <textarea id="jobDescription" rows="6" class="form-input w-full px-4 py-3 border border-gray-300 rounded-lg" placeholder="Describe the role, responsibilities, and requirements..." required></textarea>
              </div>
              
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Requirements</label>
                  <div id="requirementsList">
                    <div class="flex mb-2 requirement-item">
                      <input type="text" class="form-input w-full px-4 py-3 border border-gray-300 rounded-lg" placeholder="Enter a requirement" />
                      <button type="button" class="remove-req-btn ml-2 text-red-500 hover:text-red-700" title="Remove"><i class="fas fa-minus-circle"></i></button>
                    </div>
                  </div>
                  <button type="button" id="addRequirementBtn" class="mt-2 px-3 py-1 bg-blue-100 text-blue-700 rounded hover:bg-blue-200 text-sm"><i class="fas fa-plus mr-1"></i>Add Requirement</button>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Benefits</label>
                  <textarea id="jobBenefits" rows="4" class="form-input w-full px-4 py-3 border border-gray-300 rounded-lg" placeholder="List benefits and perks..."></textarea>
                </div>
              </div>
              
              <div class="flex justify-end space-x-4">
                <button type="button" onclick="showTab('jobs')" class="px-6 py-3 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors">
                  Cancel
                </button>
                <button type="submit" class="btn-primary px-6 py-3 rounded-lg text-white font-medium">
                  <i class="fas fa-save mr-2"></i>Post Job
                </button>
              </div>
            </form>
          </div>
        </div>
      </main>
    </div>

    <!-- Application Detail Modal -->
    <div id="applicationModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
      <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-xl shadow-xl max-w-2xl w-full max-h-screen overflow-y-auto">
          <div class="p-6 border-b border-gray-200">
            <div class="flex justify-between items-center">
              <h3 class="text-xl font-semibold">Application Details</h3>
              <button onclick="closeApplicationModal()" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times text-xl"></i>
              </button>
            </div>
          </div>
          <div class="p-6" id="applicationModalContent">
            <!-- Application details will be populated here -->
          </div>
          <div class="p-6 border-t border-gray-200 flex justify-end space-x-4">
            <button onclick="updateApplicationStatus('rejected')" class="px-4 py-2 border border-red-300 text-red-600 rounded-lg hover:bg-red-50 transition-colors">
              Reject
            </button>
            <button onclick="updateApplicationStatus('approved')" class="btn-primary px-4 py-2 rounded-lg text-white">
              Approve
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Firebase data variables
      let jobs = [];
      let applications = [];
      let currentApplicationId = null;
      let jobsUnsubscribe = null;
      let applicationsUnsubscribe = null;

      // Initialize dashboard
      document.addEventListener('DOMContentLoaded', async function() {
        await updateDashboard();
        const lastTab = localStorage.getItem('selectedTab') || 'dashboard';
        showTab(lastTab);
        setupRealtimeListeners();
      });

      // Tab navigation
      function showTab(tabName) {
        // Save selected tab to localStorage
        localStorage.setItem('selectedTab', tabName);

        // Hide all tab contents
        document.querySelectorAll('.tab-content').forEach(tab => {
          tab.classList.add('hidden');
        });

        // Remove active class from all tab buttons
        document.querySelectorAll('.tab-btn').forEach(btn => {
          btn.classList.remove('tab-active');
        });

        // Show selected tab
        document.getElementById(tabName).classList.remove('hidden');

        // Add active class to the correct button
        document.querySelectorAll('.tab-btn').forEach(btn => {
          if (btn.textContent.trim().replace(/\s+/g, '').toLowerCase().includes(tabName.replace('-', ''))) {
            btn.classList.add('tab-active');
          }
        });

        // Load tab-specific content
        if (tabName === 'jobs') {
          loadJobsTable();
        } else if (tabName === 'applications') {
          loadApplications();
        }
      }

      // Mobile sidebar toggle
      function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        sidebar.classList.toggle('open');
      }

      // Set up real-time listeners
      function setupRealtimeListeners() {
        // Listen for jobs changes
        jobsUnsubscribe = FirebaseService.onJobsSnapshot((updatedJobs) => {
          jobs = updatedJobs;
          updateDashboardStats();
          if (document.getElementById('jobs').classList.contains('hidden') === false) {
            loadJobsTable();
          }
        });

        // Listen for applications changes
        applicationsUnsubscribe = FirebaseService.onApplicationsSnapshot((updatedApplications) => {
          applications = updatedApplications;
          updateDashboardStats();
          if (document.getElementById('applications').classList.contains('hidden') === false) {
            loadApplications();
          }
        });
      }

      // Update dashboard stats
      function updateDashboardStats() {
        const activeJobs = jobs.filter(job => job.status === 'active').length;
        const totalApplications = applications.length;
        const newApplications = applications.filter(app => app.status === 'new').length;
        const approvedApplications = applications.filter(app => app.status === 'approved').length;

        document.getElementById('activeJobsCount').textContent = activeJobs;
        document.getElementById('totalApplicationsCount').textContent = totalApplications;
        document.getElementById('newApplicationsCount').textContent = newApplications;
        document.getElementById('approvedCount').textContent = approvedApplications;

        loadRecentApplications();
        loadActiveJobs();
      }

      // Update dashboard (legacy function for compatibility)
      async function updateDashboard() {
        try {
          jobs = await FirebaseService.getJobs();
          applications = await FirebaseService.getApplications();
          updateDashboardStats();
        } catch (error) {
          console.error('Error updating dashboard:', error);
        }
      }

      // Load recent applications for dashboard
      function loadRecentApplications() {
        const container = document.getElementById('recentApplications');
        const recentApps = applications.slice(0, 5);
        
        container.innerHTML = recentApps.length === 0 ? 
          '<p class="text-gray-500 text-center py-4">No applications yet</p>' :
          recentApps.map(app => `
            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
              <div>
                <p class="font-medium text-gray-800">${app.fullName}</p>
                <p class="text-sm text-gray-500">${app.position}</p>
              </div>
              <span class="status-badge status-${app.status}">${app.status}</span>
            </div>
          `).join('');
      }

      // Load active jobs for dashboard
      function loadActiveJobs() {
        const container = document.getElementById('activeJobs');
        const activeJobs = jobs.filter(job => job.status === 'active').slice(0, 5);
        
        container.innerHTML = activeJobs.length === 0 ? 
          '<p class="text-gray-500 text-center py-4">No active jobs</p>' :
          activeJobs.map(job => `
            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
              <div>
                <p class="font-medium text-gray-800">${job.title}</p>
                <p class="text-sm text-gray-500">${job.location}</p>
              </div>
              <span class="text-sm text-gray-500">${job.applications || 0} apps</span>
            </div>
          `).join('');
      }

      // Load jobs table
      function loadJobsTable() {
        const tbody = document.getElementById('jobsTableBody');
        
        tbody.innerHTML = jobs.map(job => `
          <tr class="hover:bg-gray-50">
            <td class="px-6 py-4 whitespace-nowrap">
              <div>
                <div class="text-sm font-medium text-gray-900">${job.title}</div>
                <div class="text-sm text-gray-500">${job.department || 'General'}</div>
              </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${job.location}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${job.type}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${job.applications || 0}</td>
            <td class="px-6 py-4 whitespace-nowrap">
              <span class="status-badge ${job.status === 'active' ? 'status-approved' : 'status-reviewing'}">${job.status}</span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
              <button onclick="editJob('${job.id}')" class="text-blue-600 hover:text-blue-900 mr-3">Edit</button>
              <button onclick="deleteJob('${job.id}')" class="text-red-600 hover:text-red-900">Delete</button>
            </td>
          </tr>
        `).join('');
      }

      // Load applications
      function loadApplications() {
        // Populate position filter dropdown
        const positionFilter = document.getElementById('positionFilter');
        if (positionFilter) {
          // Get unique positions from applications
          const uniquePositions = Array.from(new Set(applications.map(app => app.position).filter(Boolean)));
          positionFilter.innerHTML = '<option value="">All Positions</option>' +
            uniquePositions.map(pos => `<option value="${pos}">${pos}</option>`).join('');
        }

        const container = document.getElementById('applicationsList');
        const statusFilter = document.getElementById('statusFilter').value;
        const selectedPosition = positionFilter ? positionFilter.value : '';
        
        let filteredApplications = applications;
        if (statusFilter) {
          filteredApplications = filteredApplications.filter(app => app.status === statusFilter);
        }
        if (selectedPosition) {
          filteredApplications = filteredApplications.filter(app => app.position === selectedPosition);
        }
        
        container.innerHTML = filteredApplications.length === 0 ? 
          '<div class="text-center py-12"><p class="text-gray-500">No applications found</p></div>' :
          filteredApplications.map(app => {
            // Handle Firestore Timestamp for appliedAt
            let appliedDate = 'Recently';
            if (app.appliedAt) {
              if (typeof app.appliedAt.toDate === 'function') {
                appliedDate = app.appliedAt.toDate().toLocaleDateString();
              } else {
                appliedDate = new Date(app.appliedAt).toLocaleDateString();
              }
            }
            
            return `
              <div class="application-card bg-white p-6 rounded-xl shadow-sm" id="appCard-${app.id}">
                <div class="flex items-start justify-between mb-4">
                  <div>
                    <h3 class="text-xl font-semibold text-gray-800">${app.fullName}</h3>
                    <p class="text-gray-600">${app.email}</p>
                    <p class="text-sm text-gray-500">${app.phone}</p>
                  </div>
                  <div class="text-right">
                    <span class="status-badge status-${app.status}">${app.status}</span>
                    <p class="text-sm text-gray-500 mt-1">${app.position}</p>
                  </div>
                </div>
                <div class="mb-4">
                  <span class="cover-letter-truncated" id="coverLetter-${app.id}">${app.coverLetter ? app.coverLetter.replace(/\n/g, ' ') : 'No cover letter provided'}</span>
                  ${app.coverLetter && app.coverLetter.length > 100 ? `<button class="expand-btn" onclick="toggleExpandApp('${app.id}')" title="Show more"><i id="chevron-${app.id}" class="fas fa-chevron-down"></i></button>` : ''}
                </div>
                <div class="flex justify-between items-center">
                  <span class="text-sm text-gray-500">Applied: ${appliedDate}</span>
                  <div class="flex space-x-2">
                    ${app.resumeURL ? 
                      app.resumeURL.includes('drive.google.com') ? 
                        `<div class="space-y-2">
                          <p class="text-gray-700">${app.resumeFileName || 'Resume uploaded to Google Drive'}</p>
                          <div class="flex space-x-2">
                            <button onclick="viewResume('${app.resumeURL}', '${app.resumeFileName || 'Resume'}')" class="icon-btn bg-green-500 hover:bg-green-600 text-white" title="View in Google Drive">
                              <i class="fab fa-google-drive"></i>
                            </button>
                            ${app.driveDownloadUrl ? 
                              `<a href="${app.driveDownloadUrl}" target="_blank" class="icon-btn bg-blue-500 hover:bg-blue-600 text-white" title="Download">
                                <i class="fas fa-download"></i>
                              </a>` : ''
                            }
                          </div>
                          <p class="text-xs text-gray-500">File stored in Google Drive</p>
                        </div>` :
                        `<div class="space-y-2">
                          <p class="text-gray-700">${app.resumeFileName || 'Resume uploaded'}</p>
                          <button onclick="viewResume('${app.resumeURL}', '${app.resumeFileName || 'Resume'}')" class="icon-btn bg-blue-500 hover:bg-blue-600 text-white" title="View Resume">
                            <i class="fas fa-eye mr-2"></i>View Resume
                          </button>
                        </div>`
                      : app.resumeUploadError ? 
                        `<div class="space-y-2">
                          <p class="text-gray-700">${app.resumeFileName || 'Resume'} (Upload Failed)</p>
                          <p class="text-red-600 text-sm">Error: ${app.resumeUploadError}</p>
                        </div>` : 
                        '<p class="text-gray-700">No resume uploaded</p>'}
                    <button onclick="viewApplication('${app.id}')" class="btn-primary view-btn" title="View">View</button>
                  </div>
                </div>
              </div>
            `;
          }).join('');
      }

      // Handle new job form submission
      document.getElementById('newJobForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        // Collect requirements as array
        const reqInputs = document.querySelectorAll('#requirementsList input');
        const requirements = Array.from(reqInputs).map(input => input.value.trim()).filter(Boolean);
        const jobData = {
          title: document.getElementById('jobTitle').value,
          location: document.getElementById('jobLocation').value,
          type: document.getElementById('jobType').value,
          department: document.getElementById('jobDepartment').value,
          description: document.getElementById('jobDescription').value,
          requirements: requirements,
          benefits: document.getElementById('jobBenefits').value
        };

        // Show loading state
        const submitButton = this.querySelector('button[type="submit"]');
        const originalText = submitButton.innerHTML;
        submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Posting Job...';
        submitButton.disabled = true;

        // Show loading overlay
        const loadingOverlay = document.getElementById('loadingOverlay');
        loadingOverlay.classList.remove('hidden');

        try {
          await FirebaseService.addJob(jobData);
          
          // Hide loading overlay
          loadingOverlay.classList.add('hidden');
          
          // Reset form
          this.reset();
          
          // Show confirmation loading
          submitButton.innerHTML = '<i class="fas fa-check mr-2"></i>Job Posted Successfully!';
          submitButton.className = submitButton.className.replace('bg-orange-500', 'bg-green-600');
          
          // Switch to jobs tab and refresh after confirmation
          setTimeout(() => {
            showTab('jobs');
            window.location.reload();
          }, 1500);
        } catch (error) {
          console.error('Error posting job:', error);
          
          // Hide loading overlay
          loadingOverlay.classList.add('hidden');
          
          alert('Error posting job. Please try again.');
        } finally {
          submitButton.innerHTML = originalText;
          submitButton.disabled = false;
        }
      });

      // View application details
      function viewApplication(appId) {
        const app = applications.find(a => a.id === appId);
        if (!app) return;
        
        currentApplicationId = appId;
        
        const modal = document.getElementById('applicationModal');
        const content = document.getElementById('applicationModalContent');
        
        // Handle Firestore Timestamp for appliedAt
        let appliedDate = 'Recently';
        if (app.appliedAt) {
          if (typeof app.appliedAt.toDate === 'function') {
            appliedDate = app.appliedAt.toDate().toLocaleString();
          } else {
            appliedDate = new Date(app.appliedAt).toLocaleString();
          }
        }
        
        content.innerHTML = `
          <div class="space-y-4">
            <div>
              <h4 class="font-semibold text-gray-800">Personal Information</h4>
              <p><strong>Name:</strong> ${app.fullName}</p>
              <p><strong>Email:</strong> ${app.email}</p>
              <p><strong>Phone:</strong> ${app.phone}</p>
            </div>
            <div>
              <h4 class="font-semibold text-gray-800">Position Applied</h4>
              <p>${app.position}</p>
            </div>
            <div>
              <h4 class="font-semibold text-gray-800">Cover Letter</h4>
              <p class="modal-cover-letter text-gray-700">${app.coverLetter || 'No cover letter provided'}</p>
            </div>
            <div>
              <h4 class="font-semibold text-gray-800">Resume</h4>
              ${app.resumeURL ? 
                app.resumeURL.includes('drive.google.com') ? 
                  `<div class="space-y-2">
                    <p class="text-gray-700">${app.resumeFileName || 'Resume uploaded to Google Drive'}</p>
                    <div class="flex space-x-2">
                      <button onclick="viewResume('${app.resumeURL}', '${app.resumeFileName || 'Resume'}')" class="icon-btn bg-green-500 hover:bg-green-600 text-white" title="View in Google Drive">
                        <i class="fab fa-google-drive"></i>
                      </button>
                      ${app.driveDownloadUrl ? 
                        `<a href="${app.driveDownloadUrl}" target="_blank" class="icon-btn bg-blue-500 hover:bg-blue-600 text-white" title="Download">
                          <i class="fas fa-download"></i>
                        </a>` : ''
                      }
                    </div>
                    <p class="text-xs text-gray-500">File stored in Google Drive</p>
                  </div>` :
                  `<div class="space-y-2">
                    <p class="text-gray-700">${app.resumeFileName || 'Resume uploaded'}</p>
                    <button onclick="viewResume('${app.resumeURL}', '${app.resumeFileName || 'Resume'}')" class="icon-btn bg-blue-500 hover:bg-blue-600 text-white" title="View Resume">
                      <i class="fas fa-eye mr-2"></i>View Resume
                    </button>
                  </div>`
                : app.resumeUploadError ? 
                  `<div class="space-y-2">
                    <p class="text-gray-700">${app.resumeFileName || 'Resume'} (Upload Failed)</p>
                    <p class="text-red-600 text-sm">Error: ${app.resumeUploadError}</p>
                  </div>` : 
                  '<p class="text-gray-700">No resume uploaded</p>'}
            </div>
            <div>
              <h4 class="font-semibold text-gray-800">Application Date</h4>
              <p>${appliedDate}</p>
            </div>
          </div>
        `;
        
        modal.classList.remove('hidden');
      }

      // View resume function
      function viewResume(resumeURL, fileName) {
        // Check if it's an image file
        const isImage = /\.(jpg|jpeg|png)$/i.test(fileName);
        
        if (isImage) {
          // For images, show in a modal
          const modal = document.getElementById('applicationModal');
          const content = document.getElementById('applicationModalContent');
          
          content.innerHTML = `
            <div class="text-center">
              <h3 class="text-xl font-semibold mb-4">${fileName}</h3>
              <img src="${resumeURL}" alt="${fileName}" class="max-w-full max-h-96 mx-auto rounded-lg shadow-lg" />
              <div class="mt-4">
                <a href="${resumeURL}" target="_blank" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded text-sm">
                  <i class="fas fa-external-link-alt mr-2"></i>Open in New Tab
                </a>
              </div>
            </div>
          `;
          
          modal.classList.remove('hidden');
        } else {
          // For PDFs and other files, open in new tab
          window.open(resumeURL, '_blank');
        }
      }

      // Close application modal
      function closeApplicationModal() {
        document.getElementById('applicationModal').classList.add('hidden');
        currentApplicationId = null;
      }

      // Update application status
      async function updateApplicationStatus(status) {
        if (!currentApplicationId) return;
        
        // Show loading overlay
        const loadingOverlay = document.getElementById('loadingOverlay');
        loadingOverlay.querySelector('p').textContent = `Updating application status to ${status}...`;
        loadingOverlay.classList.remove('hidden');
        
        try {
          await FirebaseService.updateApplicationStatus(currentApplicationId, status);
          
          closeApplicationModal();
          
          // Show confirmation
          loadingOverlay.querySelector('p').textContent = `Application ${status}! Refreshing page...`;
          
          // Refresh the page to show updated status
          setTimeout(() => {
            window.location.reload();
          }, 1500);
        } catch (error) {
          console.error('Error updating application status:', error);
          
          // Hide loading overlay
          loadingOverlay.classList.add('hidden');
          
          alert('Error updating application status. Please try again.');
        }
      }

      // Edit job
      function editJob(jobId) {
        const job = jobs.find(j => j.id === jobId);
        if (!job) return;
        
        // Populate form with job data
        document.getElementById('jobTitle').value = job.title;
        document.getElementById('jobLocation').value = job.location;
        document.getElementById('jobType').value = job.type;
        document.getElementById('jobDepartment').value = job.department || '';
        document.getElementById('jobDescription').value = job.description;
        // Populate dynamic requirements
        const reqList = document.getElementById('requirementsList');
        reqList.innerHTML = '';
        if (Array.isArray(job.requirements) && job.requirements.length > 0) {
          job.requirements.forEach(req => {
            const div = document.createElement('div');
            div.className = 'flex mb-2 requirement-item';
            div.innerHTML = `<input type="text" class="form-input w-full px-4 py-3 border border-gray-300 rounded-lg" placeholder="Enter a requirement" value="${req.replace(/"/g, '&quot;')}" />
              <button type="button" class="remove-req-btn ml-2 text-red-500 hover:text-red-700" title="Remove"><i class="fas fa-minus-circle"></i></button>`;
            reqList.appendChild(div);
          });
        } else {
          // At least one field
          const div = document.createElement('div');
          div.className = 'flex mb-2 requirement-item';
          div.innerHTML = `<input type="text" class="form-input w-full px-4 py-3 border border-gray-300 rounded-lg" placeholder="Enter a requirement" />
            <button type="button" class="remove-req-btn ml-2 text-red-500 hover:text-red-700" title="Remove"><i class="fas fa-minus-circle"></i></button>`;
          reqList.appendChild(div);
        }
        updateRemoveReqBtns();
        document.getElementById('jobBenefits').value = job.benefits || '';
        
        // Switch to new job tab
        showTab('new-job');
      }

      // Delete job
      async function deleteJob(jobId) {
        if (confirm('Are you sure you want to delete this job posting?')) {
          // Show loading overlay
          const loadingOverlay = document.getElementById('loadingOverlay');
          loadingOverlay.querySelector('p').textContent = 'Deleting job posting...';
          loadingOverlay.classList.remove('hidden');
          
          try {
            await FirebaseService.deleteJob(jobId);
            
            // Show confirmation
            loadingOverlay.querySelector('p').textContent = 'Job deleted! Refreshing page...';
            
            // Refresh the page to show updated job list
            setTimeout(() => {
              window.location.reload();
            }, 1500);
          } catch (error) {
            console.error('Error deleting job:', error);
            
            // Hide loading overlay
            loadingOverlay.classList.add('hidden');
            
            alert('Error deleting job. Please try again.');
          }
        }
      }

      // Status filter change
      document.getElementById('statusFilter').addEventListener('change', loadApplications);
      // Position filter change
      document.getElementById('positionFilter').addEventListener('change', loadApplications);

      // Close modal when clicking outside
      document.getElementById('applicationModal').addEventListener('click', function(e) {
        if (e.target === this) {
          closeApplicationModal();
        }
      });

      // Migration helper - uncomment to migrate data from localStorage to Firebase
      // FirebaseService.migrateFromLocalStorage();

      function toggleExpandApp(appId) {
        const card = document.getElementById('appCard-' + appId);
        const cover = document.getElementById('coverLetter-' + appId);
        const chevron = document.getElementById('chevron-' + appId);
        if (card.classList.contains('expanded')) {
          card.classList.remove('expanded');
          cover.classList.remove('expanded');
          chevron.classList.remove('fa-chevron-up');
          chevron.classList.add('fa-chevron-down');
        } else {
          card.classList.add('expanded');
          cover.classList.add('expanded');
          chevron.classList.remove('fa-chevron-down');
          chevron.classList.add('fa-chevron-up');
        }
      }

      // Dynamic Requirements Field Logic
      function updateRemoveReqBtns() {
        document.querySelectorAll('.remove-req-btn').forEach(btn => {
          btn.onclick = function() {
            const item = btn.closest('.requirement-item');
            if (item && document.querySelectorAll('.requirement-item').length > 1) {
              item.remove();
            }
          };
        });
      }
      document.getElementById('addRequirementBtn').onclick = function() {
        const list = document.getElementById('requirementsList');
        const div = document.createElement('div');
        div.className = 'flex mb-2 requirement-item';
        div.innerHTML = `<input type="text" class="form-input w-full px-4 py-3 border border-gray-300 rounded-lg" placeholder="Enter a requirement" />
          <button type="button" class="remove-req-btn ml-2 text-red-500 hover:text-red-700" title="Remove"><i class="fas fa-minus-circle"></i></button>`;
        list.appendChild(div);
        updateRemoveReqBtns();
      };
      updateRemoveReqBtns();
    </script>
  </body>
</html>
